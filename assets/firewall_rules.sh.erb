<%="#!/bin/bash"%>
#GENERATED BY SPRINKLE on <%= Time.now.strftime("%Y-%m-%d %H:%M") %> Do not edit by hand - or be sorry

PATH='/sbin'

iptables --flush	  # delete all existing rules
iptables --delete-chain	  # delete all user-defined chains
iptables --zero		  # reset all counters

# Default policies
iptables --policy INPUT   DROP
iptables --policy OUTPUT  DROP
iptables --policy FORWARD DROP

# Disable all trafic over IPv6 : it does not get enabled at all
# TODO: Support for IPv6
ip6tables --policy INPUT    DROP
ip6tables --policy OUTPUT   DROP
ip6tables --policy FORWARD  DROP

# Enable loopback traffic
iptables --append INPUT  --in-interface  lo --jump ACCEPT
iptables --append OUTPUT --out-interface lo --jump ACCEPT

# Enable statefull rules: after that, only need to allow NEW conections
iptables --append INPUT   -m conntrack --ctstate ESTABLISHED,RELATED --jump ACCEPT
iptables --append OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED --jump ACCEPT
iptables --append FORWARD -m conntrack --ctstate ESTABLISHED,RELATED --jump ACCEPT

# Drop invalid state packets
iptables --append INPUT   -m conntrack --ctstate INVALID --jump DROP
iptables --append OUTPUT  -m conntrack --ctstate INVALID --jump DROP
iptables --append FORWARD -m conntrack --ctstate INVALID --jump DROP

### INPUT

# Incoming ssh from the internet
#iptables --append INPUT -p tcp --dport 22 -m conntrack --ctstate NEW --jump ACCEPT

#incoming traffic on our allowed ports
<% EXPOSED_TCP_PORTS.each do |port|%>
  iptables --append INPUT -p tcp --dport <%=port%> -m conntrack --ctstate NEW --jump ACCEPT
<% end %>

#incoming traffic on our whitelisted IPs
iptables --append INPUT -p tcp --source <%= WHITELISTED_IPv4S.join(',') %> -m conntrack --ctstate NEW --jump ACCEPT

## OUTPUT

# This box may open any connection to the outside world
iptables --append OUTPUT --destination 0.0.0.0/0 -m conntrack --ctstate NEW --jump ACCEPT

## FORWARD

# We need this if we are a router

#iptables --append FORWARD -m conntrack --ctstate NEW --jump ACCEPT

## LOGGING

# These logging rules fill a medium sized log partition
# within a month. Rotate your logs or be warned!

#iptables --append INPUT   --jump LOG --log-level DEBUG --log-prefix '[FW INPUT]:    '
#iptables --append OUTPUT  --jump LOG --log-level DEBUG --log-prefix '[FW OUTPUT]:   '
#iptables --append FORWARD --jump LOG --log-level DEBUG --log-prefix '[FW FORWARD ]: '
